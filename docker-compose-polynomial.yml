services:
  ra1-polynomial-regression:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ra1-polynomial-regression
    volumes:
      - ./ml_inference/models:/app/models
      - ./ml_inference/inference.py:/app/inference.py
    environment:
      - PYTHONUNBUFFERED=1
      - MODEL_TYPE=polynomial_regression
      - ROUTER_TYPE=ra
      - MODEL_VERSION=${MODEL_VERSION:-1.0.0}
      - KAFKA_INPUT_TOPIC=ra_1_input
      - KAFKA_OUTPUT_TOPIC=ra_1_output
      - KAFKA_BROKERS=kafka:9092
      - LOG_LEVEL=INFO
      - EPSILON=0.01
    depends_on:
      kafka:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - default

  rb1-polynomial-regression:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rb1-polynomial-regression
    volumes:
      - ./ml_inference/models:/app/models
      - ./ml_inference/inference.py:/app/inference.py
    environment:
      - PYTHONUNBUFFERED=1
      - MODEL_TYPE=polynomial_regression
      - ROUTER_TYPE=rb
      - MODEL_VERSION=${MODEL_VERSION:-1.0.0}
      - KAFKA_INPUT_TOPIC=rb_1_input
      - KAFKA_OUTPUT_TOPIC=rb_1_output
      - KAFKA_BROKERS=kafka:9092
      - LOG_LEVEL=INFO
      - EPSILON=0.01
    depends_on:
      kafka:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - default

  telemetry-mock:
    build:
      context: ./telemetry_mock
      dockerfile: Dockerfile
    container_name: telemetry-mock
    environment:
      - KAFKA_INPUT_TOPICS=ra_1_input,rb_1_input
      - KAFKA_OUTPUT_TOPICS=ra_1_output,rb_1_output
      - KAFKA_BROKERS=kafka:9092
      - INTERVAL=0.0
      - INPUT_TEMPLATE=/app/data/mock_data/input_ml_metrics.json
      - LOG_LEVEL=INFO
      - USE_REAL_DATA=true
      - TEST_DATA_PATH=/app/data/test_data
      - PLOTS_DIR=/app/plots
      - PLOT_INTERVAL=1000
      - VERSION=1.0.0
    volumes:
      - ./telemetry_mock/plots:/app/plots
      - ./telemetry_mock/outputs:/app/outputs
      - ./telemetry_mock/data:/app/data
    depends_on:
      kafka:
        condition: service_healthy
      ra1-polynomial-regression:
        condition: service_started
      rb1-polynomial-regression:
        condition: service_started
    profiles:
      - telemetry_mock
    restart: unless-stopped
    networks:
      - default

  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_ADVERTISED_HOST_NAME=kafka
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CREATE_TOPICS=ra_1_input:1:1,ra_1_output:1:1,rb_1_input:1:1,rb_1_output:1:1
      - KAFKA_LOG4J_LOGGERS=org.apache.zookeeper=WARN,org.apache.kafka=WARN,kafka=WARN,kafka.cluster=WARN,kafka.controller=WARN,kafka.coordinator=WARN,kafka.log=WARN,kafka.server=WARN,kafka.zookeeper=WARN,state.change.logger=WARN
      - KAFKA_LOG4J_ROOT_LOGLEVEL=WARN
    depends_on:
      zookeeper:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list && echo 'Kafka ready' || exit 1"]
      interval: 10s
      timeout: 20s
      retries: 10
      start_period: 30s
    networks:
      - default

  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      - ZOO_LOG4J_PROP=WARN,CONSOLE
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc localhost 2181 | grep imok || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - default

networks:
  default:
    name: tc32_default_network
